{% load django_tables2 %}
{% load crud_tags %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
{% load adminlte_helpers %}
{% load static %}
{% load i18n %}
{% load l10n %}
{#<style>#}
{#    .modal-open .modal-backdrop {#}
{#      backdrop-filter: blur(1px);#}
{#      background-color: rgba(0, 0, 0, 0.5);#}
{#      opacity: 1 !important;#}
{#    }#}
{#</style>#}

<div id="dialog" class="modal-dialog modal-dialog-centered modal-dialog-scrollable" style="max-width: {{ max_width }}" role="document">
    {{ form.media.js }}
    <form
            id="id_form_modal"
{#            hx-post="{{ request.path }}" #}
{#            hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'#}
{#            {% if hx_target %}hx-target="{{ hx_target }}"{% endif %} #}
{#            {% if hx_swap %}hx-swap="{{ hx_swap }}"{% endif %}#}
            class="modal-content" 
            style="max-width: {{ max_width }}"
            action="{% if action == 'create'%}{{url_create}}{%else%}{{url_update}}{% endif %}{{getparams}}"
            method="POST" 
            enctype="multipart/form-data"
            tabindex="-1"
    >
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title">{{  modal_form_title }}</h5>
                <button hx-get="{{ url_list }}{{getparams_hx}}" 
                        {% if hx_target %}hx-target="{{ hx_target }}" {% else %}hx-target="#main_content_swap"{% endif %}
                        {% if hx_swap %}hx-swap="{{ hx_swap }}" {% else %}hx-swap="outerHTML"{% endif %}
                        hx-trigger="click"
                        type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding-bottom: 0">
                {% if form.helper %}
                    {% crispy form %}
                {% else %}
                    {{ form|crispy }}
                {% endif %}
                {% if inlines and action == 'update' or action == 'detail' %}
                    <div class="card-body row" style="padding: 0">
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                {% for inline in inlines%}
                                <div class="panel-heading">
                                    <h3 class="panel-title">{{inline.title}}</h3>
                                </div>
                                <div class="card-body" style="padding: 0">
                                    <div id="{{inline.name}}_father">
                                        {% if 'create' in inline.views_available and action == 'update' and not object.tipodocumento.generado %}
                                            <button class="btn btn-success"
                                                    hx-get="{% crud_inline_url form.instance inline.model 'create' namespace %}"
                                                    hx-target="#edit_modal_inner"
{#                                                data-href="{% crud_inline_url form.instance inline.model 'create' namespace %}"#}
                                                id="#{{ name }}_{{ object.pk }}_add"
{#                                                data-replace-inner="#edit_modal_inner"#}
                        
                        
{#                                                data-replace-inner="#{{inline.name}}_editList"#}
{#                                                data-ajax="" data-success="function(){}"#}
                                                style="margin-top: 0px; margin-bottom: 5px;">
                                                Adicionar Producto
                                            </button>
                                        {% endif %}
                                        {% if 'list' in inline.views_available %}
                                            <div id="id_{{ inline.name }}_myList">
                                                <a id="id_{{inline.name}}_btn" 
                                                   hx-get="{% crud_inline_url form.instance inline.model 'list' namespace %}" 
                                                   hx-target="#id_{{inline.name}}_myList"
                                                   hx-trigger="load"
                                                   href="{% crud_inline_url form.instance inline.model 'list' namespace %}"
                                                >
                                                    <i class='fa fa-spinner fa-spin '></i>
                                                </a>
                                            </div>
                                        {% endif %}
                                        <div id="{{inline.name}}_editList"></div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% if inline_tables and action is not 'create' %}
                    <div class="card-body row" style="padding: 0">
                        <div class="col-md-12">
                            {% for inline_table in inline_tables %}
                                {% if inline_table.visible %}
                                    {% if inline_table.title %}
                                        <div class="panel-heading">
                                            <h5 class="panel-title">{{ inline_table.title }}</h5>
                                        </div>
                                    {% endif %}                                      
                                    <div id="id_{{inline_table.name}}_father">
                                        <div id="id_{{ inline_table.name }}_swap" class="shadow border dark:border border-gray-200 sm:rounded-lg max-h-[650px]"
                                             style="height: inherit;">
                                            {% render_table inline_table.table %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                {% endif %} 
            </div>
            
            
            <div class="modal-footer">
                {% if form_view %}
                    <button id="id_form_btn_cancel" name="form_btn_cancel" type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fa fa-close"></i>
                        Cancelar
                    </button>
                    {% if btn_generar_doc %}
                    	<button 
                                id="id_form_btn_gen_doc" name="form_btn_gen_doc" class="btn btn-primary" data-dismiss="modal">
                                <i class="fa fa-check"></i>
                                {{  btn_generar_doc }}
                        </button>
                    {% else %}
                        <button hx-headers='{"X-CSRFToken":"{{ csrf_token }}", "event_action": "submitted"}'
                            hx-vals='{"event_action": "submitted"}'
                            hx-post="{{ request.path }}{{ getparams }}"
                            hx-trigger="click"
                            {% if hx_target %}hx-target="{{ hx_target }}" {% else %}hx-target="#main_content_swap"{% endif %}
                            {% if hx_swap %}hx-swap="{{ hx_swap }}" {% else %}hx-swap="outerHTML"{% endif %}
                            id="id_form_btn_acept" 
                            type="submit" 
                            name="form_btn_acept"
                            class="btn btn-primary">
                            <i class="fa fa-check"></i> 
                            {{  btn_aceptar }}
                        </button>
                    {% endif %} 
{#                    <button hx-headers='{"X-CSRFToken":"{{ csrf_token }}", "event_action": "submitted"}'#}
{#                            hx-vals='{"event_action": "submitted"}'#}
{#                            hx-post="{{ request.path }}{{ getparams }}"#}
{#                            hx-trigger="click"#}
{#                            {% if hx_target %}hx-target="{{ hx_target }}" {% else %}hx-target="#main_content_swap"{% endif %}#}
{#                            {% if hx_swap %}hx-swap="{{ hx_swap }}" {% else %}hx-swap="outerHTML"{% endif %}#}
{#                            id="id_form_btn_acept" #}
{#                            type="submit" #}
{#                            name="form_btn_acept"#}
{#                            class="btn btn-primary">#}
{#                        <i class="fa fa-check"></i> #}
{#                        {{  btn_aceptar }}#}
{#                    </button>#}
                    {% if btn_rechazar %}
                    	<button hx-headers='{"X-CSRFToken":"{{ csrf_token }}", "event_action": "refused"}'
                            hx-post="{{ request.path }}"
                            hx-trigger="click"
                            hx-vals='{"event_action": "refused"}'
                            {% if hx_target %}hx-target="{{ hx_target }}" {% else %}hx-target="#main_content_swap"{% endif %}
                            {% if hx_swap %}hx-swap="{{ hx_swap }}" {% else %}hx-swap="outerHTML"{% endif %}
                            id="id_form_btn_refuse" 
                            type="submit" 
                            name="form_btn_refuse"
                            class="btn btn-danger">
                        <i class="fa fa-ban"></i> 
                        {{  btn_rechazar }}
                    </button>
                    {% endif %} 
                {% endif %}
            </div>
            </div>
        
    </form>
</div>
    
<style>
    .custom-control-input {
        z-index: 1;
    }
</style>
<script>

    $(function () {
        //Initialize Select2 Elements
        $('.select2').select2()

        //Initialize Select2 Elements
        $('.select2bs4').select2({
          theme: 'bootstrap4'
        })
    });

    window.data = {
        filterTextClear: '{{ filterTextClear|safe }}',
        filterPlaceHolder: '{{ filterPlaceHolder|safe }}',
        moveSelectedLabel: '{{ moveSelectedLabel|safe }}',
        moveAllLabel: '{{ moveAllLabel|safe }}',
        removeSelectedLabel: '{{ removeSelectedLabel|safe }}',
        removeAllLabel: '{{ removeAllLabel|safe }}',
        infoText1: '{{ infoText1|safe }}',
        infoText2: '{{ infoText2|safe }}',
        infoTextFiltered: '{{ infoTextFiltered|safe }}',
        infoTextEmpty: '{{ infoTextEmpty|safe }}',
        today: '{{ today|safe }}',
        clear: '{{ clear|safe }}',
        close: '{{ close|safe }}',
        selectMonth: '{{ selectMonth|safe }}',
        prevMonth: '{{ prevMonth|safe }}',
        nextMonth: '{{ nextMonth|safe }}',
        selectYear: '{{ selectYear|safe }}',
        prevYear: '{{ prevYear|safe }}',
        nextYear: '{{ nextYear|safe }}',
        selectDecade: '{{ selectDecade|safe }}',
        prevDecade: '{{ prevDecade|safe }}',
        nextDecade: '{{ nextDecade|safe }}',
        prevCentury: '{{ prevCentury|safe }}',
        nextCentury: '{{ nextCentury|safe }}',
        pickHour: '{{ pickHour|safe }}',
        incrementHour: '{{ incrementHour|safe }}',
        decrementHour: '{{ decrementHour|safe }}',
        pickMinute: '{{ pickMinute|safe }}',
        incrementMinute: '{{ incrementMinute|safe }}',
        decrementMinute: '{{ decrementMinute|safe }}',
        pickSecond: '{{ pickSecond|safe }}',
        incrementSecond: '{{ incrementSecond|safe }}',
        decrementSecond: '{{ decrementSecond|safe }}',
        togglePeriod: '{{ togglePeriod|safe }}',
        selectTime: '{{ selectTime|safe }}'
    }
    function getContainer(){
        return document.querySelector('#id_form_modal');
    }     

    //let container = document.querySelector('#id_form_modal'); // <----- Fill in your div container here and its done

    function getFocusable(context = 'document') {
      return Array.from(context.querySelectorAll('button, [href], input:not([type="hidden"]), textarea, select, [tabindex]:not([tabindex="-1"])')).filter(function (el) { return !el.closest('[hidden]'); });
    }
    function getFocusableItems() {
        return getFocusable(getContainer());
    }
    document.getElementById('id_form_modal').addEventListener("keydown", function (e) {
      if ( window.getComputedStyle(getContainer()).display === "none") {
        return;
      }
      if (e.key === 'Tab') { // Tab & Shift+Tab
        const focusedItem = e.target;
        const focusedItemIndex = getFocusableItems().indexOf(focusedItem);
        if (e.shiftKey) {
          if (!getContainer().contains(e.target) || focusedItemIndex === 0) {
            getFocusableItems()[getFocusableItems().length - 1].focus();
            e.preventDefault();
          }
        } else {
          if (!getContainer().contains(e.target) || focusedItemIndex === getFocusableItems().length - 1) {
            getFocusableItems()[0].focus();
            e.preventDefault();
          }
        }
      }
    });
    $(function () {
        //Initialize Select2 Elements
        $('.select2').select2()

        //Initialize Select2 Elements
        $('.select2bs4').select2({
          theme: 'bootstrap4'
        })
    })
    document.getElementById('id_form_btn_gen_doc').addEventListener('click', function() {
        // Genera la URL del PDF usando la URL configurada en Django
        const url = "{% url 'app_index:flujo:report_test' %}";
        // Abre el PDF en una nueva pestaña
        window.open(url, '_blank');
    });
</script>
